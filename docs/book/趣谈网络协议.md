# DNS：网络世界的地址簿

## 什么是DNS服务器

记得住网站的名称，但是很难记住网站的ip地址，因此 也需要一个地址簿，即DNS （Domain Name System,域名系统）服务器。

每个上网的人都要访问他，所以对他来讲是一个巨大的调整，因而，DNS服务器一 定要设置成高可用、高并发和分布式的。

于是，就有了树状的层次结构。

根DNS服务器：返回顶级域DNS服务器的IP地址。
•顶级DNS服务器：返回权威DNS服务器的IP地址。
•权威DNS服务器：返回相应主机的IP地址。



## DNS解析流程

1、客户端发起dns解析请求，将请求发 给本地DNS服务器。本地dns服务器通常在某个网络服务商的某个机房。

2、本地DNS服务器收到来自客户端的请求。从缓存里面查找域名对于的ip地址，如果找不到则问他的根服务器。根DNS服务器是最高层次的，全球共有13套，它不直接用于域名解析，但能 为本地DNS服务器指明一条道路。

3、根服务器收到来自本地DNS服务器的请求，发现后缀是.com,此时就会返回com所在的顶级服务器地址。

4、本地DNS服务器转问顶级DNS服务器，此时会拿到二级域名，然后再里面查找该二级域名所在的权威域名的服务器。

5、本地DNS服务器转问权威DNS服务器，权威DNS服务器查询后将对应的IP地址"x.x.x.x”告诉本地DNS服务器。本地服务器此时会缓存。

6、本地DNS服务器再将IP地址返回客户端，客户端和目标建立连接。


## 负载均衡

将一个域名配置多个ip地址，在域名解析时，只要配置策 略，就可以这次返回第一个IP地址，下次返回第二个IP地址，进而实现负载均衡。

DNS服务器还可以做全局负载均衡。

为了保证我们的应用高可用，数据中心往往会部署在多个机房，每个地方都会有自己的IP 地址。当用户访问某个域名的时候，这个IP地址可以轮询访问多个数据中心。如果一个数据中 心因为某种原因发生了故障，只要在DNS服务器里将这个数据中心对应的IP地址删除，就可 以实现一定的高可用。
另外，我们肯定希望北京的用户访问北京的数据中心，上海的用户访问上海的数据中心， 这样，客户体验会非常好，访问速度也会很快。这就是全局负载均衡的概念。

HTTPDNS

传统DNS服务器存在哪些问题

1、 域名缓存问题

域名更新不及时

2、域名转发问题

成都的解析请求转发到了上海，此时就可能按照负载均衡策略路由到上海去。

3、出口NAT问题

很多机房都会在出口配置NAT,即网络地址转换，从而给从 这个网关出去的包都换上新的IP地址，当然请求返回时，可以再在这个网关将IP地址转换回 去，所以对于访问来说没有任何问题。

但是一旦做了IP地址的转换，权威DNS服务器就没办法通过这个地址来判断客户到底来 自哪个运营商，而且极有可能因为地址被转换过使得权威DNS服务器误判运营商，进而导致客 户每次都要跨运营商进行访问。


4、域名更新问题

5、解析延迟问题

DNS服务器的查询过程需要递归遍历多个DNS服务器，才能获得最终的解 析结果，这会带来一定的时延，甚至会导致解析超时。

HTTPDNS服务器的工作模式

HTTPDNS服务器不通过传统的DNS服务器进行解析，而是自己搭建基于HTTP的DNS 服务器集群，并分布在多个地点，针对多个运营商。当客户端需要DNS解析时，直接通过HTTP 请求这个服务器集群，就能得到就近的地址。

这就相当于各自基于HTTP实现自己的域名解析，做一个自己的地址簿，而不使用统一的 地址簿。但是默认的域名解析都是通过DNS服务器实现的，因而使用HTTPDNS需要绕过默认 的DNS路径，不能使用默认的客户端。使用HTTPDNS服务器的，往往是手机应用，需要在手机端嵌入支持HTTPDNS的客户端SDK （Software Development Kit,软件开发工具包）。



HTTPDNS服务器的缓存设计

解析DNS服务器的过程复杂，通信次数多，这对解析速度造成了很大影响。为了加快解析， 所以有了缓存，但是这又会产生缓存更新不及时的问题。最要命的是，解析速度和更新速度都 掌握在本地DNS服务器手中，它不会为客户端进行定制，客户端只能干着急。

而HTTPDNS服务器将解析速度和更新速度全部掌控在自己手中。一方面，解析时不需要 本地DNS服务器递归地调用一大圈，一个HTTP请求直接搞定，要实时更新时，马上就能起作 用；另一方面，为了提高解析速度，本地也有缓存，缓存是由客户端SDK维护的，过期时间和 更新时间都可以自己控制。

HTTPDNS服务器采用的缓存设计模式也是做应用架构时常用的缓存设计模式，即分为客 户端、缓存、数据源三层。这三层对于应用架构来讲，就是应用、缓存、数据库。常见的是Tomcat、Redis, MySQL；对于HTTPDNS服务器来讲，就是客户端SDK、本地缓存、HTTPDNS服务器。



只要是缓存模式，就存在缓存的过期、更新、不一致等问题，解决这些问题的思路也是很 像的。例如DNS服务器缓存在内存中，也可以持久化到存储上，这样App重启之后，就能尽 快从存储中加载上次累积的经常访问的网站解析结果，而不需要每次都解析一遍，再变成缓存。 这有点像Redis虽是基于内存的缓存，但是同样能提供持久化的能力，使得重启或者主备切换 时，数据不会完全丢失。

SDK中的缓存会严格按照缓存过期时间执行，如果缓存已经过期，且客户端不允许使用过 期的记录，则会发起一次解析，保障记录是最新的。

解析可以同步进行，也就是直接调用HTTPDNS服务器的接口，返回最新的记录，更新缓 存。也可以异步进行，添加一个解析任务到后台，由后台任务调用HTTPDNS服务器的接口。

同步更新的优点是实时性好，缺点是当多个请求都过期时，就会同时请求HTTPDNS服务 器多次，这其实是一种浪费。

同步更新的方式对应应用架构中缓存的Cache-Aside机制，即先读缓存，若读取失败则读 数据库，同时更新缓存，



异步更新的优点是，可以将多个请求都过期的情况合并为一个对HTTPDNS服务器的请求 任务，只执行一次，减少HTTPDNS服务器的压力。同时可以在数据即将过期时创建一个任务 进行预加载，防止过期之后再刷新。

异步更新的缺点是，当前请求拿到过期数据时，如果客户端允许使用过期数据，则需要冒 一次风险。如果过期的数据还能请求，就没问题，如果不能请求，则会失败，等下次缓存更新 后再请求方能成功，

CDN

CDN这个技术其实说起来并不复杂，最初的核心理念，就是将内容缓存在终端用户附近。
内容源不是远么？那么，我们就在靠近用户的地方，建一个缓存服务器，把远端的内容，复制一份，放在这里，不就OK了？


因为这项技术是把内容进行了分发，所以，它的名字就叫做CDN——Content Delivery Network，内容分发网络。

具体来说，CDN就是采用更多的缓存服务器（CDN边缘节点），布放在用户访问相对集中的地区或网络中。当用户访问网站时，利用全局负载技术，将用户的访问指向距离最近的缓存服务器上，由缓存服务器响应用户请求。（有点像电商的本地仓吧？）

